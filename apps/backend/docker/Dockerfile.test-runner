# Dockerfile for Integration Test Runner
# Build context: monorepo root (.)

FROM node:20-slim AS base

# Install OpenSSL for Prisma, postgresql-client for PostGIS setup
RUN apt-get update -y && apt-get install -y openssl postgresql-client && rm -rf /var/lib/apt/lists/*

RUN corepack enable
WORKDIR /usr/src/app

# Copy root package files
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./

# Copy workspace packages (includes prisma schema in relationaldb-provider)
COPY packages/ ./packages/

# Copy backend package files and source
COPY apps/backend/package.json ./apps/backend/
COPY apps/backend/tsconfig.* ./apps/backend/
COPY apps/backend/nest-cli.json ./apps/backend/
COPY apps/backend/src/ ./apps/backend/src/
COPY apps/backend/__tests__/ ./apps/backend/__tests__/

# Copy migration script for db-migrate service
COPY apps/backend/docker/scripts/db-migrate.sh /usr/local/bin/db-migrate.sh
RUN chmod +x /usr/local/bin/db-migrate.sh

# Copy test-runner script for database verification before tests
COPY apps/backend/docker/scripts/test-runner.sh /usr/local/bin/test-runner.sh
RUN chmod +x /usr/local/bin/test-runner.sh

# Install dependencies from monorepo root
RUN --mount=type=cache,id=pnpm,target=/pnpm/store pnpm install --frozen-lockfile

# Generate database client from provider package
RUN pnpm --filter @qckstrt/relationaldb-provider db:generate

# Build all workspace packages (required for TypeScript resolution)
RUN pnpm --filter "./packages/*" build

# Set working directory for tests
WORKDIR /usr/src/app/apps/backend

# Run integration tests (db:push handled by db-migrate service)
CMD ["pnpm", "test:integration"]