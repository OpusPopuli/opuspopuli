# Docker Compose for Integration Testing
#
# Thin overlay on docker-compose-services.yml that adds:
#   - Container name prefixes (opuspopuli-integration-*)
#   - API Gateway on port 3000
#   - Test runner container (activated with --profile test)
#
# Usage:
#   # One command (builds, tests, cleans up):
#   pnpm test:integration:docker
#
#   # Or manually:
#   docker compose -f docker-compose-integration.yml up -d --build
#   pnpm test:integration
#   docker compose -f docker-compose-integration.yml down -v

include:
  - docker-compose-services.yml  # Infrastructure + backend microservices

services:
  # Set container names for integration environment
  db-migrate:
    container_name: opuspopuli-db-migrate

  users:
    container_name: opuspopuli-integration-users

  documents:
    container_name: opuspopuli-integration-documents

  knowledge:
    container_name: opuspopuli-integration-knowledge

  region:
    container_name: opuspopuli-integration-region

  api:
    container_name: opuspopuli-integration-api
    ports:
      - "3000:8080"

  # Test runner container - runs integration tests inside Docker
  # Builds its own node_modules to ensure correct platform bindings
  test-runner:
    build:
      context: .
      dockerfile: apps/backend/docker/Dockerfile.test-runner
      args:
        NODE_AUTH_TOKEN: ${NODE_AUTH_TOKEN:-}
    container_name: opuspopuli-test-runner
    # Run test-runner script which verifies database state before running tests
    command: ["/bin/sh", "/usr/local/bin/test-runner.sh"]
    environment:
      NODE_ENV: test
      PROJECT: opuspopuli
      VERSION: 1.0.0
      RESEND_API_KEY: re_test_placeholder_key
      RELATIONAL_DB_PROVIDER: postgres
      RELATIONAL_DB_HOST: supabase-db
      RELATIONAL_DB_PORT: 5432
      RELATIONAL_DB_USERNAME: postgres
      RELATIONAL_DB_PASSWORD: your-super-secret-password
      RELATIONAL_DB_DATABASE: postgres
      DATABASE_URL: postgresql://postgres:your-super-secret-password@supabase-db:5432/postgres
      REDIS_URL: redis://redis:6379
      SUPABASE_URL: http://supabase-kong:8000
      SUPABASE_ANON_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0
      SUPABASE_SERVICE_ROLE_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImV4cCI6MTk4MzgxMjk5Nn0.EGIM96RAZx35lJzdJsyH-qQwv8Hdp7fsn3W0YpN81IU
      GATEWAY_CLIENT_ID: api-gateway
      GATEWAY_HMAC_SECRET: integration-test-hmac-secret
      API_KEYS: '{"api-gateway":"integration-test-hmac-secret"}'
      JWT_SECRET: your-super-secret-jwt-token-with-at-least-32-characters
      AUTH_JWT_SECRET: your-super-secret-jwt-token-with-at-least-32-characters
      # Container networking URLs
      INBUCKET_URL: http://inbucket:9000
      API_GATEWAY_URL: http://api:8080
      USERS_SERVICE_URL: http://users:8080
      DOCUMENTS_SERVICE_URL: http://documents:8080
      KNOWLEDGE_SERVICE_URL: http://knowledge:8080
      REGION_SERVICE_URL: http://region:8080
    depends_on:
      api:
        condition: service_healthy
    networks:
      - opuspopuli-network
    profiles:
      - test
