# PR Validation Workflow
#
# This workflow prevents region-specific provider packages from being
# added to the core repository. Region-specific civic data is configured
# as declarative plugins (JSON config in the database).
#
# Allowed:
# - packages/region-provider/ (core plugin loader + declarative plugin support)
#
# Blocked:
# - packages/region-provider-california/
# - packages/region-provider-texas/
# - packages/region-provider-*/ (any region-specific provider package)

name: PR Validation

on:
  pull_request:
    branches: [main, develop]

jobs:
  validate-region-providers:
    name: Validate Region Providers
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
        with:
          fetch-depth: 0

      - name: Check for non-example region providers
        run: |
          echo "Checking for non-example region providers..."

          # Get list of changed files in PR
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)

          # Check for region provider packages other than the example
          BLOCKED_PROVIDERS=""
          for file in $CHANGED_FILES; do
            # Check if file is in a region-provider-* directory (but not region-provider/)
            if [[ "$file" =~ ^packages/region-provider-[^/]+/ ]]; then
              PROVIDER_DIR=$(echo "$file" | cut -d'/' -f1-2)
              if [[ ! "$BLOCKED_PROVIDERS" =~ "$PROVIDER_DIR" ]]; then
                BLOCKED_PROVIDERS="$BLOCKED_PROVIDERS $PROVIDER_DIR"
              fi
            fi
          done

          if [ -n "$BLOCKED_PROVIDERS" ]; then
            echo ""
            echo "================================================================"
            echo "ERROR: Region-specific provider packages detected!"
            echo "================================================================"
            echo ""
            echo "The following region provider packages were found in this PR:"
            echo "$BLOCKED_PROVIDERS" | tr ' ' '\n' | grep -v '^$' | sed 's/^/  - /'
            echo ""
            echo "The core repository should only contain the base platform"
            echo "and the region-provider (declarative plugin loader)."
            echo ""
            echo "Region-specific data is configured as declarative plugins"
            echo "(JSON config in the database), not as code packages."
            echo ""
            echo "See docs/guides/region-provider.md for instructions."
            echo ""
            echo "If you believe this is an error, please contact the maintainers."
            echo "================================================================"
            exit 1
          fi

          echo "No region-specific provider packages found."
          echo "PR validation passed."
