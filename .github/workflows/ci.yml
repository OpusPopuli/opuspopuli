name: CI

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: Setup pnpm
        uses: pnpm/action-setup@a7487c7e89a18df4991f7f222e4898a00d66ddda # v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run linting
        run: pnpm lint

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@a7487c7e89a18df4991f7f222e4898a00d66ddda # v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm -r --filter './packages/*' build

      - name: Run tests with coverage
        run: pnpm test:ci

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b # v4
        with:
          name: coverage-reports
          path: |
            apps/frontend/coverage/
            apps/backend/coverage/
            packages/*/coverage/
          retention-days: 1

  sonarcloud:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest
    needs: [test]
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@a7487c7e89a18df4991f7f222e4898a00d66ddda # v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm -r --filter './packages/*' build

      - name: Download coverage artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4
        with:
          name: coverage-reports
          path: coverage-reports

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@383f7e52eae3ab0510c3cb0e7d9d150bbaeab838 # v3
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: Setup pnpm
        uses: pnpm/action-setup@a7487c7e89a18df4991f7f222e4898a00d66ddda # v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm -r --filter './packages/*' build

      - name: Build backend
        run: pnpm --filter backend build

      - name: Build frontend
        run: pnpm --filter frontend build

  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [test]  # Changed from [build] - no need to wait for build since we rebuild frontend here
    timeout-minutes: 45
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: Setup pnpm
        uses: pnpm/action-setup@a7487c7e89a18df4991f7f222e4898a00d66ddda # v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: |
          # Full browser set on main, Chromium only on PRs
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            pnpm --filter frontend exec playwright install --with-deps
          else
            pnpm --filter frontend exec playwright install --with-deps chromium
          fi

      - name: Start backend services
        run: |
          echo "Starting E2E backend services..."
          docker compose -f docker-compose-e2e.yml up -d --build --wait --wait-timeout 600 \
            supabase-db redis inbucket db-migrate users documents knowledge region api
          echo "Service status:"
          docker compose -f docker-compose-e2e.yml ps

      - name: Build packages
        run: pnpm -r --filter './packages/*' build

      - name: Run backend integration tests
        run: pnpm test:integration
        env:
          # API gateway runs on port 4000 in E2E docker-compose
          API_GATEWAY_URL: http://localhost:4000
          # Database connection for Prisma
          DATABASE_URL: postgresql://postgres:your-super-secret-password@localhost:5432/postgres

      - name: Build frontend
        run: pnpm --filter frontend build
        env:
          # API gateway runs on port 4000 in E2E docker-compose
          NEXT_PUBLIC_GRAPHQL_URL: http://localhost:4000/graphql

      - name: Copy static assets for standalone build
        run: |
          # Next.js standalone requires static files to be copied manually
          # See: https://nextjs.org/docs/app/api-reference/config/next-config-js/output
          cp -r apps/frontend/.next/static apps/frontend/.next/standalone/apps/frontend/.next/static
          cp -r apps/frontend/public apps/frontend/.next/standalone/apps/frontend/public

      - name: Run E2E tests
        run: |
          # Full browser matrix on main, Chromium only on PRs
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            pnpm --filter frontend e2e
          else
            pnpm --filter frontend e2e --project=chromium
          fi

      - name: Show backend logs on failure
        if: failure()
        run: |
          echo "=== Docker Compose Service Status ==="
          docker compose -f docker-compose-e2e.yml ps

          echo ""
          echo "=== API Gateway Logs ==="
          docker compose -f docker-compose-e2e.yml logs api --tail=100

          echo ""
          echo "=== Users Service Logs ==="
          docker compose -f docker-compose-e2e.yml logs users --tail=50

          echo ""
          echo "=== Database Logs ==="
          docker compose -f docker-compose-e2e.yml logs supabase-db --tail=50

      - name: Stop backend services
        if: always()
        run: docker compose -f docker-compose-e2e.yml down -v

      - name: Upload Playwright report
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b # v4
        if: ${{ !cancelled() }}
        with:
          name: playwright-report
          path: apps/frontend/playwright-report/
          retention-days: 7
