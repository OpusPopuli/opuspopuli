name: Integration Tests

on:
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

concurrency:
  group: integration-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  integration:
    name: Backend Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: Start all services
        run: |
          echo "Starting docker-compose services..."
          # Start only the services needed for integration tests
          # (skip supabase-rest, supabase-storage, supabase-studio, supabase-meta, ollama which we don't use)
          docker compose -f docker-compose-integration.yml up -d --build --wait --wait-timeout 600 \
            supabase-db redis inbucket db-migrate users documents knowledge region api

          echo "Service status:"
          docker compose -f docker-compose-integration.yml ps

      - name: Run integration tests
        run: |
          docker compose -f docker-compose-integration.yml --profile test run --rm test-runner

      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== Docker Compose Service Status ==="
          docker compose -f docker-compose-integration.yml ps

          echo ""
          echo "=== API Gateway Logs ==="
          docker compose -f docker-compose-integration.yml logs api --tail=100

          echo ""
          echo "=== Users Service Logs ==="
          docker compose -f docker-compose-integration.yml logs users --tail=100

          echo ""
          echo "=== Documents Service Logs ==="
          docker compose -f docker-compose-integration.yml logs documents --tail=100

          echo ""
          echo "=== Knowledge Service Logs ==="
          docker compose -f docker-compose-integration.yml logs knowledge --tail=100

          echo ""
          echo "=== Region Service Logs ==="
          docker compose -f docker-compose-integration.yml logs region --tail=100

          echo ""
          echo "=== Database Logs ==="
          docker compose -f docker-compose-integration.yml logs supabase-db --tail=50

      - name: Stop all services
        if: always()
        run: docker compose -f docker-compose-integration.yml --profile test down -v