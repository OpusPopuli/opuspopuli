# Docker Compose - Backend Microservices (Shared)
#
# Shared microservice definitions used by all environment-specific compose files.
# Extends the base docker-compose.yml (Supabase + infrastructure stack) and adds
# backend microservices: Users, Documents, Knowledge, Region, and API Gateway.
#
# DO NOT use this file directly. Use one of the environment overlays:
#   - docker-compose-integration.yml  → Integration testing (with test-runner)
#   - docker-compose-e2e.yml          → E2E testing (API on port 4000 for Playwright)
#   - docker-compose-uat.yml          → Manual UAT (LLM + region config for validation)

include:
  - docker-compose.yml  # Base: Supabase, Redis, Ollama, observability

x-backend-env: &backend-env
  NODE_ENV: test
  # Service metadata
  PROJECT: opuspopuli
  VERSION: 1.0.0
  # Email (placeholder for testing - won't actually send)
  RESEND_API_KEY: re_test_placeholder_key
  # Database
  RELATIONAL_DB_PROVIDER: postgres
  RELATIONAL_DB_HOST: supabase-db
  RELATIONAL_DB_PORT: 5432
  RELATIONAL_DB_USERNAME: postgres
  RELATIONAL_DB_PASSWORD: your-super-secret-password
  RELATIONAL_DB_DATABASE: postgres
  # Prisma DATABASE_URL (required for Prisma ORM)
  DATABASE_URL: postgresql://postgres:your-super-secret-password@supabase-db:5432/postgres
  # Redis (distributed caching)
  REDIS_URL: redis://redis:6379
  # Supabase
  SUPABASE_URL: http://supabase-kong:8000
  SUPABASE_ANON_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0
  SUPABASE_SERVICE_ROLE_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImV4cCI6MTk4MzgxMjk5Nn0.EGIM96RAZx35lJzdJsyH-qQwv8Hdp7fsn3W0YpN81IU
  # HMAC Authentication (API Gateway <-> Microservices)
  GATEWAY_CLIENT_ID: api-gateway
  GATEWAY_HMAC_SECRET: integration-test-hmac-secret
  API_KEYS: '{"api-gateway":"integration-test-hmac-secret"}'
  # JWT
  JWT_SECRET: your-super-secret-jwt-token-with-at-least-32-characters
  AUTH_JWT_SECRET: your-super-secret-jwt-token-with-at-least-32-characters

services:
  # Database migration service - runs before microservices to create tables
  db-migrate:
    build:
      context: .
      dockerfile: apps/backend/docker/Dockerfile.test-runner
      args:
        NODE_AUTH_TOKEN: ${NODE_AUTH_TOKEN:-}
    environment:
      <<: *backend-env
    depends_on:
      supabase-db:
        condition: service_healthy
    # Run the db-migrate script which handles Prisma db:push and PostGIS setup
    # The script is baked into the Docker image to ensure reliable execution
    command: ["/usr/local/bin/db-migrate.sh"]
    networks:
      - opuspopuli-network
    # This service should exit after migration completes

  users:
    build:
      context: .
      dockerfile: apps/backend/docker/Dockerfile.users
      args:
        NODE_AUTH_TOKEN: ${NODE_AUTH_TOKEN:-}
    environment:
      <<: *backend-env
      APPLICATION: users
      DESCRIPTION: Users microservice
      PORT: 8080
    ports:
      - "3001:8080"
    depends_on:
      db-migrate:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:8080/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
      - opuspopuli-network
    restart: unless-stopped

  documents:
    build:
      context: .
      dockerfile: apps/backend/docker/Dockerfile.documents
      args:
        NODE_AUTH_TOKEN: ${NODE_AUTH_TOKEN:-}
    environment:
      <<: *backend-env
      APPLICATION: documents
      DESCRIPTION: Documents microservice
      PORT: 8080
    ports:
      - "3002:8080"
    depends_on:
      db-migrate:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:8080/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
      - opuspopuli-network
    restart: unless-stopped

  knowledge:
    build:
      context: .
      dockerfile: apps/backend/docker/Dockerfile.knowledge
      args:
        NODE_AUTH_TOKEN: ${NODE_AUTH_TOKEN:-}
    environment:
      <<: *backend-env
      APPLICATION: knowledge
      DESCRIPTION: Knowledge microservice
      PORT: 8080
    ports:
      - "3003:8080"
    depends_on:
      db-migrate:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:8080/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
      - opuspopuli-network
    restart: unless-stopped

  region:
    build:
      context: .
      dockerfile: apps/backend/docker/Dockerfile.region
      args:
        NODE_AUTH_TOKEN: ${NODE_AUTH_TOKEN:-}
    environment:
      <<: *backend-env
      APPLICATION: region
      DESCRIPTION: Region microservice
      PORT: 8080
    ports:
      - "3004:8080"
    depends_on:
      db-migrate:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:8080/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
      - opuspopuli-network
    restart: unless-stopped

  # API Gateway - port mapping defined by each overlay file
  # (integration/UAT use 3000, E2E uses 4000 to avoid frontend conflict)
  api:
    build:
      context: .
      dockerfile: apps/backend/docker/Dockerfile.api
      args:
        NODE_AUTH_TOKEN: ${NODE_AUTH_TOKEN:-}
    environment:
      <<: *backend-env
      APPLICATION: api
      DESCRIPTION: API Gateway
      PORT: 8080
      MICROSERVICES: '[{"name":"users","url":"http://users:8080/graphql"},{"name":"documents","url":"http://documents:8080/graphql"},{"name":"knowledge","url":"http://knowledge:8080/graphql"},{"name":"region","url":"http://region:8080/graphql"}]'
    depends_on:
      users:
        condition: service_healthy
      documents:
        condition: service_healthy
      knowledge:
        condition: service_healthy
      region:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:8080/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
      - opuspopuli-network
    restart: unless-stopped
